name: build

on:
  - push
  - pull_request

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      minio:
        image: minio/minio
        ports:
          - 9000:9000
        environment:
          MINIO_ROOT_USER: 'root'
          MINIO_ROOT_PASSWORD: 'password'
          MINIO_API_SELECT_PARQUET: 'on'
        command: minio server /data/minio

    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      - run: pip install -r requirements.txt
      - run: pip install -r requirements-dev.txt
      - run: python -m unittest discover -vb tests/
      - run: python -m unittest discover -vb tests/unit
      - run: python -m unittest discover -vb tests/integration

  image:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - run: docker build . -t readql

  deploy:
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    needs:
      - test
      - image
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: current
          cache: npm
      - run: npm ci
      - run: npx serverless deploy --verbose
